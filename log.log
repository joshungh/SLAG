(venv) cmcoca@Mac SLAG-site % pytest backend/tests/test_story_generation.py::test_chapter_generation -v --log-cli-level=INFO
================================================================================================================== test session starts ===================================================================================================================
platform darwin -- Python 3.11.11, pytest-7.4.3, pluggy-1.5.0 -- /Users/cmcoca/Desktop/SLAG-site/backend/venv/bin/python3.11
cachedir: .pytest_cache
rootdir: /Users/cmcoca/Desktop/SLAG-site/backend
plugins: asyncio-0.23.5
asyncio: mode=Mode.STRICT
collected 1 item                                                                                                                                                                                                                                         

backend/tests/test_story_generation.py::test_chapter_generation 
--------------------------------------------------------------------------------------------------------------------- live log setup ---------------------------------------------------------------------------------------------------------------------
INFO     backend.tests.conftest:conftest.py:18 Pinecone API Key: pcsk_7TB...
INFO     backend.tests.conftest:conftest.py:19 Pinecone Environment: apw5-4e34-81fa
--------------------------------------------------------------------------------------------------------------------- live log call ----------------------------------------------------------------------------------------------------------------------
INFO     backend.tests.conftest:conftest.py:25 Initializing RAG service...
INFO     botocore.credentials:credentials.py:1278 Found credentials in shared credentials file: ~/.aws/credentials
INFO     backend.tests.conftest:conftest.py:31 Indexing test documents...
INFO     src.services.rag_service:rag_service.py:87 Indexing with metadata: {'type': 'character_profile', 'name': 'Dr. James Chen', 'current_location': 'Station Omega'}
INFO     src.services.rag_service:rag_service.py:88 Document content length: 4975
INFO     src.services.rag_service:rag_service.py:61 Split document into 11 chunks
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 492
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 499
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 499
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 496
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 495
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 497
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 499
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 490
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 491
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 489
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 107
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.rag_service:rag_service.py:77 Generated embeddings for 11 chunks
INFO     src.services.rag_service:rag_service.py:124 Successfully indexed document: /Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/characters/character-chen.txt
INFO     backend.tests.conftest:conftest.py:75 Indexed test document: /Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/characters/character-chen.txt
INFO     src.services.rag_service:rag_service.py:87 Indexing with metadata: {'type': 'location', 'name': 'Station Omega', 'location_type': 'station'}
INFO     src.services.rag_service:rag_service.py:88 Document content length: 5880
INFO     src.services.rag_service:rag_service.py:61 Split document into 12 chunks
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 496
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 496
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 498
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 497
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 495
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 498
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 498
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 498
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 499
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 487
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 494
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 309
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.rag_service:rag_service.py:77 Generated embeddings for 12 chunks
INFO     src.services.rag_service:rag_service.py:124 Successfully indexed document: /Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/world/slag-locations.txt
INFO     backend.tests.conftest:conftest.py:75 Indexed test document: /Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/world/slag-locations.txt
INFO     src.services.rag_service:rag_service.py:87 Indexing with metadata: {'type': 'story_planning', 'category': 'initial_setup'}
INFO     src.services.rag_service:rag_service.py:88 Document content length: 1116
INFO     src.services.rag_service:rag_service.py:61 Split document into 2 chunks
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 491
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 370
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.rag_service:rag_service.py:77 Generated embeddings for 2 chunks
INFO     src.services.rag_service:rag_service.py:124 Successfully indexed document: /Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/story-planning/initial-story-plan.txt
INFO     backend.tests.conftest:conftest.py:75 Indexed test document: /Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/story-planning/initial-story-plan.txt
INFO     backend.tests.conftest:conftest.py:77 RAG service initialization complete
INFO     src.services.chapter_handler:chapter_handler.py:18 
==================== Generating Chapter 1 Plan ====================
INFO     src.services.chapter_handler:chapter_handler.py:19 Active Plot Threads:
INFO     src.services.chapter_handler:chapter_handler.py:21 - Strange Fragment Behavior (Priority: 1, Status: PlotStatus.ACTIVE)
INFO     src.services.chapter_handler:chapter_handler.py:23 
Unresolved Plots from Previous Chapters:
INFO     src.services.rag_service:rag_service.py:214 Querying with filters: {'type': 'story_planning'} in namespace: story_planning
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 2011
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.pinecone_service:pinecone_service.py:122 Found 2 matches in namespace: story_planning
INFO     src.services.rag_service:rag_service.py:186 Found 2 unique chunks for query
INFO     src.services.rag_service:rag_service.py:228 Context chunk 1:
INFO     src.services.rag_service:rag_service.py:229 Text: {"Commander Drake": "professional"} } ], "scene_plans": [ { "scene_number": 1, "focus": "plot", "key_characters": ["Dr. James Chen"], "location": "Station Omega", "objective": "Discover Fragment anoma...
INFO     src.services.rag_service:rag_service.py:230 Score: 0.653402269
INFO     src.services.rag_service:rag_service.py:231 Metadata: {'category': 'initial_setup', 'chunk_id': 1.0, 'filename': 'initial-story-plan.txt', 'size': 370.0, 'source': '/Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/story-planning/initial-story-plan.txt', 'text': '{"Commander Drake": "professional"} } ], "scene_plans": [ { "scene_number": 1, "focus": "plot", "key_characters": ["Dr. James Chen"], "location": "Station Omega", "objective": "Discover Fragment anomaly", "expected_outcome": "Initial crisis revealed", "plot_threads": ["initial_crisis"] } ], "expected_outcomes": ["Crisis established", "Key characters introduced"] } ```', 'type': 'story_planning'}
INFO     src.services.rag_service:rag_service.py:228 Context chunk 2:
INFO     src.services.rag_service:rag_service.py:229 Text: # Initial Story Plan ## Core Plot Elements ```json { "theme": "Discovery and Crisis", "plot_threads": [ { "id": "initial_crisis", "title": "Strange Fragment Behavior", "status": "active", "priority": ...
INFO     src.services.rag_service:rag_service.py:230 Score: 0.641337514
INFO     src.services.rag_service:rag_service.py:231 Metadata: {'category': 'initial_setup', 'chunk_id': 0.0, 'filename': 'initial-story-plan.txt', 'size': 491.0, 'source': '/Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/story-planning/initial-story-plan.txt', 'text': '# Initial Story Plan ## Core Plot Elements ```json { "theme": "Discovery and Crisis", "plot_threads": [ { "id": "initial_crisis", "title": "Strange Fragment Behavior", "status": "active", "priority": 1, "related_characters": ["Dr. James Chen", "Commander Drake"] } ], "character_arcs": [ { "character_id": "Dr. James Chen", "current_state": "Investigating Fragment anomalies", "development_goals": ["Understand Fragment behavior", "Prevent catastrophe"], "relationships": {"Commander Drake":', 'type': 'story_planning'}
INFO     src.services.bedrock_service:bedrock_service.py:43 Attempt 1: Invoking Claude with 4096 max tokens
INFO     src.services.rag_service:rag_service.py:256 Raw response from Claude:
INFO     src.services.rag_service:rag_service.py:257 --------------------------------------------------------------------------------
INFO     src.services.rag_service:rag_service.py:258 {
    "theme": "Fragment Investigation",
    "plot_threads": [
        {
            "id": "initial_crisis",
            "title": "Strange Fragment Behavior",
            "status": "active",
            "priority": 1,
            "related_characters": ["Dr. James Chen", "Commander Drake"]
        }
    ],
    "character_arcs": [
        {
            "character_id": "Dr. James Chen",
            "current_state": "Investigating Fragment anomalies",
            "development_goals": ["Understand Fragment behavior", "Prevent catastrophe"],
            "relationships": {
                "Commander Drake": "professional"
            }
        }
    ],
    "scene_plans": [
        {
            "scene_number": 1,
            "focus": "plot",
            "key_characters": ["Dr. James Chen"],
            "location": "Station Omega",
            "objective": "Initial Fragment analysis",
            "expected_outcome": "Discovery of anomalous readings",
            "plot_threads": ["initial_crisis"]
        },
        {
            "scene_number": 2,
            "focus": "character",
            "key_characters": ["Dr. James Chen", "Commander Drake"],
            "location": "Command Center",
            "objective": "Report findings to command",
            "expected_outcome": "Escalation of concern",
            "plot_threads": ["initial_crisis"]
        },
        {
            "scene_number": 3,
            "focus": "plot",
            "key_characters": ["Dr. James Chen"],
            "location": "Research Lab",
            "objective": "Further Fragment testing",
            "expected_outcome": "Unexpected Fragment reaction",
            "plot_threads": ["initial_crisis"]
        }
    ],
    "expected_outcomes": [
        "Fragment anomaly confirmed",
        "Command structure alerted",
        "Research complications revealed"
    ]
}
INFO     src.services.rag_service:rag_service.py:259 --------------------------------------------------------------------------------
INFO     src.services.rag_service:rag_service.py:261 Generated RAG response successfully
INFO     src.services.chapter_handler:chapter_handler.py:30 
Chapter Plan Generated:
INFO     src.services.chapter_handler:chapter_handler.py:31 Theme: Fragment Investigation
INFO     src.services.chapter_handler:chapter_handler.py:32 
Plot Threads:
INFO     src.services.chapter_handler:chapter_handler.py:34 - Strange Fragment Behavior (PlotStatus.ACTIVE)
INFO     src.services.chapter_handler:chapter_handler.py:36 
Character Arcs:
INFO     src.services.chapter_handler:chapter_handler.py:38 - Dr. James Chen: Investigating Fragment anomalies
INFO     src.services.chapter_handler:chapter_handler.py:39   Goals: Understand Fragment behavior, Prevent catastrophe
INFO     src.services.chapter_handler:chapter_handler.py:41 
Scene Plans:
INFO     src.services.chapter_handler:chapter_handler.py:43 
Scene 1:
INFO     src.services.chapter_handler:chapter_handler.py:44 Location: Station Omega
INFO     src.services.chapter_handler:chapter_handler.py:45 Focus: plot
INFO     src.services.chapter_handler:chapter_handler.py:46 Characters: Dr. James Chen
INFO     src.services.chapter_handler:chapter_handler.py:47 Objective: Initial Fragment analysis
INFO     src.services.chapter_handler:chapter_handler.py:48 Expected Outcome: Discovery of anomalous readings
INFO     src.services.chapter_handler:chapter_handler.py:43 
Scene 2:
INFO     src.services.chapter_handler:chapter_handler.py:44 Location: Command Center
INFO     src.services.chapter_handler:chapter_handler.py:45 Focus: character
INFO     src.services.chapter_handler:chapter_handler.py:46 Characters: Dr. James Chen, Commander Drake
INFO     src.services.chapter_handler:chapter_handler.py:47 Objective: Report findings to command
INFO     src.services.chapter_handler:chapter_handler.py:48 Expected Outcome: Escalation of concern
INFO     src.services.chapter_handler:chapter_handler.py:43 
Scene 3:
INFO     src.services.chapter_handler:chapter_handler.py:44 Location: Research Lab
INFO     src.services.chapter_handler:chapter_handler.py:45 Focus: plot
INFO     src.services.chapter_handler:chapter_handler.py:46 Characters: Dr. James Chen
INFO     src.services.chapter_handler:chapter_handler.py:47 Objective: Further Fragment testing
INFO     src.services.chapter_handler:chapter_handler.py:48 Expected Outcome: Unexpected Fragment reaction
INFO     src.services.chapter_handler:chapter_handler.py:50 
Expected Chapter Outcomes:
INFO     src.services.chapter_handler:chapter_handler.py:52 - Fragment anomaly confirmed
INFO     src.services.chapter_handler:chapter_handler.py:52 - Command structure alerted
INFO     src.services.chapter_handler:chapter_handler.py:52 - Research complications revealed
INFO     src.services.story_engine_service:story_engine_service.py:68 Generated new chapter plan with 3 scenes
INFO     src.services.story_engine_service:story_engine_service.py:72 Generating scene 1
INFO     src.services.rag_service:rag_service.py:214 Querying with filters: {'type': 'story_planning'} in namespace: story_planning
INFO     src.services.bedrock_service:bedrock_service.py:78 Generating embedding for text of length 1390
INFO     src.services.bedrock_service:bedrock_service.py:113 Successfully generated embedding
INFO     src.services.pinecone_service:pinecone_service.py:122 Found 2 matches in namespace: story_planning
INFO     src.services.rag_service:rag_service.py:186 Found 2 unique chunks for query
INFO     src.services.rag_service:rag_service.py:228 Context chunk 1:
INFO     src.services.rag_service:rag_service.py:229 Text: {"Commander Drake": "professional"} } ], "scene_plans": [ { "scene_number": 1, "focus": "plot", "key_characters": ["Dr. James Chen"], "location": "Station Omega", "objective": "Discover Fragment anoma...
INFO     src.services.rag_service:rag_service.py:230 Score: 0.767706752
INFO     src.services.rag_service:rag_service.py:231 Metadata: {'category': 'initial_setup', 'chunk_id': 1.0, 'filename': 'initial-story-plan.txt', 'size': 370.0, 'source': '/Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/story-planning/initial-story-plan.txt', 'text': '{"Commander Drake": "professional"} } ], "scene_plans": [ { "scene_number": 1, "focus": "plot", "key_characters": ["Dr. James Chen"], "location": "Station Omega", "objective": "Discover Fragment anomaly", "expected_outcome": "Initial crisis revealed", "plot_threads": ["initial_crisis"] } ], "expected_outcomes": ["Crisis established", "Key characters introduced"] } ```', 'type': 'story_planning'}
INFO     src.services.rag_service:rag_service.py:228 Context chunk 2:
INFO     src.services.rag_service:rag_service.py:229 Text: # Initial Story Plan ## Core Plot Elements ```json { "theme": "Discovery and Crisis", "plot_threads": [ { "id": "initial_crisis", "title": "Strange Fragment Behavior", "status": "active", "priority": ...
INFO     src.services.rag_service:rag_service.py:230 Score: 0.692066789
INFO     src.services.rag_service:rag_service.py:231 Metadata: {'category': 'initial_setup', 'chunk_id': 0.0, 'filename': 'initial-story-plan.txt', 'size': 491.0, 'source': '/Users/cmcoca/Desktop/SLAG-site/backend/src/reference-documents/story-planning/initial-story-plan.txt', 'text': '# Initial Story Plan ## Core Plot Elements ```json { "theme": "Discovery and Crisis", "plot_threads": [ { "id": "initial_crisis", "title": "Strange Fragment Behavior", "status": "active", "priority": 1, "related_characters": ["Dr. James Chen", "Commander Drake"] } ], "character_arcs": [ { "character_id": "Dr. James Chen", "current_state": "Investigating Fragment anomalies", "development_goals": ["Understand Fragment behavior", "Prevent catastrophe"], "relationships": {"Commander Drake":', 'type': 'story_planning'}
INFO     src.services.bedrock_service:bedrock_service.py:43 Attempt 1: Invoking Claude with 4096 max tokens
INFO     src.services.rag_service:rag_service.py:256 Raw response from Claude:
INFO     src.services.rag_service:rag_service.py:257 --------------------------------------------------------------------------------
INFO     src.services.rag_service:rag_service.py:258 {
    "content": "Dr. James Chen frowned at the holographic display floating above his workstation in Station Omega's main laboratory. The Fragment readings made no sense. Where the crystalline structure had maintained stable patterns for months, it now pulsed with irregular energy signatures he'd never seen before. 'This can't be right,' he muttered, adjusting the calibration for the third time. The numbers remained stubbornly anomalous. As he reached for his comm unit to alert Commander Drake, a sharp crack echoed through the lab. The Fragment specimen in the containment chamber had developed a hairline fracture, something that should have been impossible given its documented properties. Warning lights began flashing as energy readings spiked dangerously. 'Security breach imminent in Containment Chamber A,' the station's AI announced with mechanical calm. Chen's fingers flew across the console, initiating emergency protocols even as his mind raced to understand what was happening. This wasn't just an anomaly - it was the beginning of a crisis.",
    "characters": ["Dr. James Chen"],
    "location": "Station Omega",
    "metadata": {
        "plot_thread": "initial_crisis",
        "focus": "plot",
        "scene_number": 1
    }
}
INFO     src.services.rag_service:rag_service.py:259 --------------------------------------------------------------------------------
INFO     src.services.rag_service:rag_service.py:261 Generated RAG response successfully
INFO     src.services.story_engine_service:story_engine_service.py:136 Successfully parsed scene content JSON
INFO     backend.tests.test_story_generation:test_story_generation.py:52 Generated scene: {'content': "Dr. James Chen frowned at the holographic display floating above his workstation in Station Omega's main laboratory. The Fragment readings made no sense. Where the crystalline structure had maintained stable patterns for months, it now pulsed with irregular energy signatures he'd never seen before. 'This can't be right,' he muttered, adjusting the calibration for the third time. The numbers remained stubbornly anomalous. As he reached for his comm unit to alert Commander Drake, a sharp crack echoed through the lab. The Fragment specimen in the containment chamber had developed a hairline fracture, something that should have been impossible given its documented properties. Warning lights began flashing as energy readings spiked dangerously. 'Security breach imminent in Containment Chamber A,' the station's AI announced with mechanical calm. Chen's fingers flew across the console, initiating emergency protocols even as his mind raced to understand what was happening. This wasn't just an anomaly - it was the beginning of a crisis.", 'characters': ['Dr. James Chen'], 'location': 'Station Omega', 'metadata': {'plot_thread': 'initial_crisis', 'focus': 'plot', 'scene_number': 1}}
PASSED                                                                                                                                                                                                                                             [100%]

==================================================================================================================== warnings summary ====================================================================================================================
backend/venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:271
  /Users/cmcoca/Desktop/SLAG-site/backend/venv/lib/python3.11/site-packages/pydantic/_internal/_config.py:271: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
============================================================================================================= 1 passed, 1 warning in 21.93s ==============================================================================================================
(venv) cmcoca@Mac SLAG-site % 
